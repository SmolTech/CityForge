# CityForge

## Migrating from before 0.9.0

0.9.0 merged the flask backend functionality into the core, which was
very disruptive.

The best way to move from 0.8.x to 0.9.0 is to export your data from
https://WEBSITE/admin/data

Convert the json to the new format with:
`node scripts/convert-export-to-0.9.0.mjs --input old.json --output ~/new.json`

Delete the namespace, and then recreate everything, and finally reimport

## warning

Most of my technical knowledge is around the infrastucture for running
this. I'm not much of a web developer, and most of the web code was
generated by using Claude Code.

I have implemented some automation around security scanning of the code,
so I'm somewhat confident that there aren't any glaring security issues.

That being said, I'm happy to hear feedback from experts, and I'd love
to find some people who want to collaborate on the project.

## Tech Stack

- **Frontend**: Next.js 15 with TypeScript
- **Styling**: Tailwind CSS
- **Code Quality**: ESLint + Prettier + Semgrep with git hooks
- **Security**: Semgrep static analysis for vulnerability detection
- **Containerization**: Docker with multi-stage builds
- **Node Version**: 20 LTS

#### Setup Node

```bash
# Install dependencies
npm install

# Set up pre-commit script
npm run prepare
```

#### Setup Python

```bash
python -m venv .venv
.venv/bin/python -m pip install -r backend/requirements.txt
.venv/bin/python -m pip install -r backend/requirements-dev.txt
.venv/bin/python -m pip install -r backend/requirements-test.txt
```

#### Environment Configuration

The project provides `.env.example` files for each component to help you get started:

```bash
# Frontend: Copy .env.example to .env.local
cp .env.example .env.local

# Backend: Copy backend/.env.example to backend/.env
cp backend/.env.example backend/.env

# Indexer: Copy indexer/.env.example to indexer/.env
cp indexer/.env.example indexer/.env
```

Edit these files with your specific configuration values. See the `.env.example` files for detailed documentation of all available environment variables and recommended values.

**Required Configuration:**

- Frontend: `NEXT_PUBLIC_API_URL` (Backend API URL)
- Backend: Database credentials, JWT secret key
- Indexer: OpenSearch connection, backend URL

For detailed documentation, see `CLAUDE.md` and the respective `.env.example` files.

#### Developing With Docker

The Docker Compose setup includes an nginx reverse proxy that mirrors the Kubernetes ingress configuration.

```bash
docker-compose up --build
```

--build can be excluded to use previous container build

To run the services in the background, run:

```bash
docker-compose up --build -d
```

##### Architecture

The Docker Compose setup includes:

- **nginx**: Reverse proxy on port 80 (entry point)
- **frontend**: Next.js app (internal port 3000)
- **backend**: Flask API (internal port 5000)
- **postgres**: PostgreSQL database (port 5432)
- **opensearch**: Search engine (ports 9200, 9600)
- **indexer**: Website crawler and indexer

Routing (matches Kubernetes ingress):

- `http://localhost/` → Frontend (Next.js)
- `http://localhost/api/config` → Frontend (Next.js API route)
- `http://localhost/api/*` → Backend (Flask API)

##### Initial database initialization for the first time

```bash
docker exec -it cityforge-backend python init_db.py
```

##### Access web interface

[http://localhost](http://localhost) (via nginx proxy)

#### Useful NPM commands

```bash
# Run development server
npm run dev

# Build for production
npm run build

# Start production server
npm start

# Run linting
npm run lint

# Format code
npm run format

# Type checking
npm run typecheck

# Security analysis
npm run semgrep
```

## Security Analysis

The project includes Semgrep for automated security vulnerability detection:

```bash
# Run security analysis
npm run semgrep

# Run security analysis (CI mode - quiet output)
npm run semgrep:ci
```

## Git Hooks

This project includes git hooks for code quality and security:

- **Pre-commit**: Runs lint-staged (ESLint + Prettier) and semgrep security analysis
- **Pre-push**: Runs type checking, linting, semgrep, and build verification

## Project Structure

```
├── src/                   # Frontend application
│   ├── app/               # Next.js app router pages
│   │   ├── admin/         # Admin dashboard
│   │   ├── api/           # API route handlers
│   │   ├── business/      # Business directory pages
│   │   ├── dashboard/     # User dashboard
│   │   ├── login/         # Login page
│   │   ├── register/      # Registration page
│   │   ├── resources/     # Resource directory pages
│   │   ├── search/        # Search interface
│   │   ├── settings/      # User settings
│   │   ├── submit/        # Business card submission
│   │   └── page.tsx       # Homepage
│   ├── components/        # React components
│   └── lib/               # Utilities and API client
├── backend/               # Flask API backend
│   ├── app/               # Application modules
│   │   ├── models.py      # Database models
│   │   ├── routes/        # API endpoints
│   │   └── utils/         # Helper functions
│   ├── tests/             # Backend tests
│   ├── uploads/           # Uploaded files
│   ├── app.py             # Flask application
│   ├── init_db.py         # Database initialization
│   └── requirements.txt   # Python dependencies
├── indexer/               # OpenSearch indexing service
│   ├── indexer.py         # Website crawler and indexer
│   └── requirements.txt   # Python dependencies
├── .github/
│   └── workflows/         # GitHub Actions CI/CD
├── .husky/                # Git hooks
├── k8s/                   # Kubernetes manifests
├── public/                # Static assets
├── scripts/               # Build and deployment scripts
├── templates/             # Email templates
├── docker-compose.yml     # Docker Compose configuration
├── nginx.conf             # Nginx reverse proxy config (for Docker Compose)
├── Dockerfile             # Frontend container
└── README.md              # Project documentation
```

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Run tests and linting
5. Submit a pull request

## License

GPLv3 License - see LICENSE file for details
