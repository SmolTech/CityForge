---
- name: Setup Cloudflare Zero Trust Tunnel
  hosts: tunnel_servers
  become: yes
  vars:
    cloudflared_version: "2024.10.0"
    cloudflared_user: "cloudflared"
    cloudflared_home: "/home/{{ cloudflared_user }}"
    cloudflared_config_dir: "/etc/cloudflared"
    tunnel_credentials_file: "{{ cloudflared_config_dir }}/{{ tunnel_uuid }}.json"
    tunnel_config_file: "{{ cloudflared_config_dir }}/config.yml"

  tasks:
    - name: Update package cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Update package cache (RedHat)
      yum:
        update_cache: yes
      when: ansible_os_family == "RedHat"

    - name: Install required packages
      package:
        name:
          - curl
          - wget
          - systemd
        state: present

    - name: Create cloudflared user
      user:
        name: "{{ cloudflared_user }}"
        system: yes
        shell: /bin/false
        home: "{{ cloudflared_home }}"
        create_home: no

    - name: Create cloudflared directories
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ cloudflared_user }}"
        group: "{{ cloudflared_user }}"
        mode: "0755"
      loop:
        - "{{ cloudflared_config_dir }}"
        - "{{ cloudflared_home }}"

    - name: Download cloudflared binary
      get_url:
        url: "https://github.com/cloudflare/cloudflared/releases/download/{{ cloudflared_version }}/cloudflared-linux-amd64"
        dest: "/usr/local/bin/cloudflared"
        mode: "0755"
        owner: root
        group: root
      register: cloudflared_download

    - name: Verify cloudflared installation
      command: /usr/local/bin/cloudflared version
      register: cloudflared_version_output
      changed_when: false

    - name: Display cloudflared version
      debug:
        msg: "Installed cloudflared version: {{ cloudflared_version_output.stdout }}"

    - name: Create tunnel credentials file
      copy:
        content: "{{ tunnel_credentials }}"
        dest: "{{ tunnel_credentials_file }}"
        owner: "{{ cloudflared_user }}"
        group: "{{ cloudflared_user }}"
        mode: "0600"
      when: tunnel_credentials is defined
      no_log: true

    - name: Generate tunnel configuration
      template:
        src: config.yml.j2
        dest: "{{ tunnel_config_file }}"
        owner: "{{ cloudflared_user }}"
        group: "{{ cloudflared_user }}"
        mode: "0644"
      notify: restart cloudflared

    - name: Create systemd service file
      template:
        src: cloudflared.service.j2
        dest: /etc/systemd/system/cloudflared.service
        owner: root
        group: root
        mode: "0644"
      notify:
        - reload systemd
        - restart cloudflared

    - name: Enable and start cloudflared service
      systemd:
        name: cloudflared
        enabled: yes
        state: started
        daemon_reload: yes

    - name: Check tunnel status
      command: /usr/local/bin/cloudflared tunnel info {{ tunnel_name }}
      register: tunnel_info
      changed_when: false
      failed_when: false

    - name: Display tunnel status
      debug:
        msg: "Tunnel info: {{ tunnel_info.stdout }}"
      when: tunnel_info.rc == 0

    - name: Configure log rotation
      copy:
        content: |
          /var/log/cloudflared/*.log {
              daily
              missingok
              rotate 7
              compress
              delaycompress
              notifempty
              copytruncate
              su {{ cloudflared_user }} {{ cloudflared_user }}
          }
        dest: /etc/logrotate.d/cloudflared
        owner: root
        group: root
        mode: "0644"

    - name: Create log directory
      file:
        path: /var/log/cloudflared
        state: directory
        owner: "{{ cloudflared_user }}"
        group: "{{ cloudflared_user }}"
        mode: "0755"

    - name: Setup firewall rules (UFW)
      ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop:
        - "22"
        - "80"
        - "443"
      when: ansible_os_family == "Debian" and enable_firewall | default(true)

    - name: Setup firewall rules (firewalld)
      firewalld:
        service: "{{ item }}"
        permanent: yes
        state: enabled
        immediate: yes
      loop:
        - ssh
        - http
        - https
      when: ansible_os_family == "RedHat" and enable_firewall | default(true)

  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: yes

    - name: restart cloudflared
      systemd:
        name: cloudflared
        state: restarted
