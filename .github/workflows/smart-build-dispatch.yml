name: Smart Build Dispatch

# Intelligent workflow that only runs necessary checks based on file changes
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: "20"
  DATABASE_URL: "postgresql://postgres:postgres@localhost:5432/cityforge_test"

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      frontend-changed: ${{ steps.changes.outputs.frontend }}
      mobile-changed: ${{ steps.changes.outputs.mobile }}
      docker-needed: ${{ steps.changes.outputs.docker }}
      security-scan-needed: ${{ steps.security.outputs.needed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            frontend:
              - 'src/**'
              - 'public/**'
              - 'tests/**'
              - 'package*.json'
              - 'tsconfig.json'
              - 'next.config.ts'
              - 'tailwind.config.ts'
              - 'vitest.config.ts'
              - 'eslint.config.mjs'
              - 'prisma/**'
            mobile:
              - 'mobile/**'
            docker:
              - 'Dockerfile'
              - 'docker-compose*.yml'
              - 'indexer/Dockerfile'
              - '.dockerignore'

      - name: Determine security scan needs
        id: security
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || \
             [[ "${{ steps.changes.outputs.frontend }}" == "true" ]] || \
             [[ "${{ steps.changes.outputs.mobile }}" == "true" ]]; then
            echo "needed=true" >> $GITHUB_OUTPUT
          else
            echo "needed=false" >> $GITHUB_OUTPUT
          fi

  # Optimized Frontend CI (inline job)
  frontend-quality:
    name: Frontend Quality & Security
    if: needs.detect-changes.outputs.frontend-changed == 'true'
    needs: detect-changes
    runs-on: ubuntu-latest # Standard runner for free tier
    timeout-minutes: 20

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: cityforge_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            .next/cache
            node_modules/.cache
            .eslintcache
          key: frontend-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ hashFiles('prisma/schema.prisma') }}
          restore-keys: |
            frontend-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-
            frontend-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Setup test database
        run: npx prisma db push --skip-generate

      - name: Quality checks
        run: |
          npm run typecheck
          npm run lint --cache  
          npm run format:check

      - name: Run tests
        run: npm run test:run -- --reporter=basic
        env:
          NODE_ENV: test

      - name: Build verification
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_URL: "http://localhost:5000"
          NEXT_TELEMETRY_DISABLED: 1

  # Optimized Mobile CI (inline job)
  mobile-quality:
    name: Mobile Quality Checks
    if: needs.detect-changes.outputs.mobile-changed == 'true'
    needs: detect-changes
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: mobile/package-lock.json

      - name: Cache mobile artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ~/.expo
            mobile/.expo
            mobile/node_modules/.cache
          key: mobile-${{ runner.os }}-${{ hashFiles('mobile/package-lock.json') }}

      - name: Install dependencies
        working-directory: mobile
        run: npm ci --prefer-offline --no-audit

      - name: TypeScript check
        working-directory: mobile
        run: npx tsc --noEmit

      - name: Lint check
        working-directory: mobile
        run: |
          if grep -q '"lint"' package.json; then
            npm run lint
          else
            echo "No lint script found, skipping..."
          fi

  # Security scan
  security-scan:
    name: Security Scan
    if: needs.detect-changes.outputs.security-scan-needed == 'true'
    needs: detect-changes
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "table"
          severity: "HIGH,CRITICAL"
          exit-code: "0" # Report but don't fail CI
          trivyignores: ".trivyignore"

  # Build status summary
  build-status:
    name: Build Status
    runs-on: ubuntu-latest
    needs: [detect-changes, frontend-quality, mobile-quality, security-scan]
    if: always()

    steps:
      - name: Build summary
        run: |
          echo "## üöÄ Smart Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes Detected:" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.detect-changes.outputs.frontend-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Mobile: ${{ needs.detect-changes.outputs.mobile-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker: ${{ needs.detect-changes.outputs.docker-needed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results:" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.frontend-quality.result }}" != "skipped" ]]; then
            echo "- Frontend: ${{ needs.frontend-quality.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Frontend: ‚è≠Ô∏è Skipped (no changes)" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.mobile-quality.result }}" != "skipped" ]]; then
            echo "- Mobile: ${{ needs.mobile-quality.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Mobile: ‚è≠Ô∏è Skipped (no changes)" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.security-scan.result }}" != "skipped" ]]; then
            echo "- Security: ${{ needs.security-scan.result == 'success' && '‚úÖ Clean' || '‚ö†Ô∏è Issues Found' }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Security: ‚è≠Ô∏è Skipped" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Overall status
        run: |
          # Fail if any required check failed
          if [[ "${{ needs.frontend-quality.result }}" == "failure" ]] || \
             [[ "${{ needs.mobile-quality.result }}" == "failure" ]]; then
            echo "‚ùå Quality checks failed"
            exit 1
          else
            echo "‚úÖ All checks passed or skipped appropriately"
          fi
