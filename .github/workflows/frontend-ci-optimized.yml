name: Frontend CI (Optimized)

on:
  workflow_call: # Allow being called from other workflows
  push:
    branches: [main, develop]
    paths:
      - "src/**"
      - "public/**"
      - "tests/**"
      - "package.json"
      - "package-lock.json"
      - "tsconfig.json"
      - "next.config.ts"
      - "tailwind.config.ts"
      - "vitest.config.ts"
      - "eslint.config.mjs"
      - "prisma/**"
      - ".github/workflows/frontend-ci-optimized.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "src/**"
      - "public/**"
      - "tests/**"
      - "package.json"
      - "package-lock.json"
      - "tsconfig.json"
      - "next.config.ts"
      - "tailwind.config.ts"
      - "vitest.config.ts"
      - "eslint.config.mjs"
      - "prisma/**"
      - ".github/workflows/frontend-ci-optimized.yml"

env:
  NODE_VERSION: "20"
  DATABASE_URL: "postgresql://postgres:postgres@localhost:5432/cityforge_test"

jobs:
  # Single comprehensive job instead of multiple parallel jobs
  quality-and-security:
    name: Quality & Security Checks
    runs-on: ubuntu-latest # Use 4-core runner for faster builds
    timeout-minutes: 20 # Prevent hanging builds

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: cityforge_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Fetch minimal history for faster checkout
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      # Enhanced caching strategy
      - name: Cache dependencies and build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            .next/cache
            node_modules/.cache
            coverage
            .eslintcache
          key: ${{ runner.os }}-build-${{ hashFiles('package-lock.json') }}-${{ hashFiles('prisma/schema.prisma') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ hashFiles('package-lock.json') }}-
            ${{ runner.os }}-build-

      - name: Install dependencies
        run: |
          # Use npm ci with frozen lockfile for faster, deterministic installs
          npm ci --prefer-offline --no-audit
          echo "‚úÖ Dependencies installed"

      - name: Generate Prisma client (cached)
        run: |
          # Check if Prisma client needs regeneration
          if [ ! -d "node_modules/.prisma" ] || [ "prisma/schema.prisma" -nt "node_modules/.prisma/client/index.js" ]; then
            echo "üîÑ Regenerating Prisma client..."
            npx prisma generate
          else
            echo "‚úÖ Using cached Prisma client"
          fi

      - name: Setup test database
        run: |
          # Only push schema if needed (faster than full migrations)
          npx prisma db push --skip-generate
          echo "‚úÖ Test database ready"

      # Run checks in parallel using background processes
      - name: Run parallel quality checks
        run: |
          # Start all checks in background
          npm run typecheck > typecheck.log 2>&1 &
          TYPECHECK_PID=$!

          npm run lint --cache > lint.log 2>&1 &
          LINT_PID=$!

          npm run format:check > format.log 2>&1 &
          FORMAT_PID=$!

          # Wait for all to complete and check results
          wait $TYPECHECK_PID
          TYPECHECK_EXIT=$?

          wait $LINT_PID  
          LINT_EXIT=$?

          wait $FORMAT_PID
          FORMAT_EXIT=$?

          # Show logs and exit with failure if any check failed
          echo "üìã TypeScript Check Results:"
          cat typecheck.log
          echo "üìã ESLint Results:"
          cat lint.log
          echo "üìã Formatting Check Results:"
          cat format.log

          if [ $TYPECHECK_EXIT -ne 0 ]; then
            echo "‚ùå TypeScript check failed"
            exit 1
          fi

          if [ $LINT_EXIT -ne 0 ]; then
            echo "‚ùå Lint check failed" 
            exit 1
          fi

          if [ $FORMAT_EXIT -ne 0 ]; then
            echo "‚ùå Format check failed"
            exit 1
          fi

          echo "‚úÖ All quality checks passed"

      # Security and dependency checks (only critical issues fail CI)
      - name: Security checks
        continue-on-error: false
        run: |
          # Critical security test
          npm run test:run -- src/lib/utils/log-redaction.test.ts

          # Check for hardcoded secrets (simplified check)
          echo "üîç Checking for hardcoded secrets..."
          SECRET_MATCHES=$(find src/ -name "*.ts" -o -name "*.tsx" | grep -v "\.test\." | xargs grep -l -E "(secret|key|token|password)" | head -10)
          if [ -n "$SECRET_MATCHES" ]; then
            echo "Files with potential secret references: $SECRET_MATCHES"
            # Only check for actual hardcoded values (20+ char strings)
            if find src/ -name "*.ts" -o -name "*.tsx" | grep -v "\.test\." | xargs grep -H -E "(secret|key|token|password)\s*[:=]\s*[\"'][a-zA-Z0-9._~+-]{20,}[\"']" | grep -v -E "(REDACTED|process\.env|Enter|Backspace)"; then
              echo "‚ùå Potential hardcoded secrets found"
              exit 1
            fi
          fi
          echo "‚úÖ No hardcoded secrets detected"

          echo "‚úÖ Security checks passed"

      # Dependency audit (warnings allowed, critical vulnerabilities fail)
      - name: Dependency security audit
        run: |
          echo "üîç Running dependency audit..."
          npm audit --audit-level=critical
          echo "‚úÖ No critical vulnerabilities found"

      # Tests with optimized execution
      - name: Run tests
        run: |
          # Run tests in parallel with optimized reporters
          npm run test:run -- --reporter=basic --run
        env:
          NODE_ENV: test
          VITEST_MIN_THREADS: 2
          VITEST_MAX_THREADS: 4

      # Build test (only if tests pass)
      - name: Build verification
        run: |
          echo "üèóÔ∏è Testing production build..."
          npm run build
          echo "‚úÖ Build successful"
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_URL: "http://localhost:5000"
          # Skip telemetry for faster builds
          NEXT_TELEMETRY_DISABLED: 1

      # Optional: Generate coverage only on main branch
      - name: Generate coverage report
        if: github.ref == 'refs/heads/main'
        run: |
          npm run test:unit:coverage -- \
            --coverage.thresholds.lines=10 \
            --coverage.thresholds.functions=40 \
            --coverage.thresholds.statements=10 \
            --coverage.thresholds.branches=30
        env:
          NODE_ENV: test

      - name: Upload coverage to Codecov
        if: github.ref == 'refs/heads/main' && success()
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  # Separate lightweight job for quick dependency checks
  dependency-check:
    name: Quick Dependency Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' # Only run on PRs

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Quick dependency check
        run: |
          # Fast check without installing dev dependencies
          npm audit --audit-level=moderate --production --dry-run
          echo "‚úÖ Production dependencies check completed"

  status-check:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [quality-and-security]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "Quality & Security: ${{ needs.quality-and-security.result }}"

          if [[ "${{ needs.quality-and-security.result }}" == "failure" ]]; then
            echo "‚ùå Build failed"
            exit 1
          else
            echo "‚úÖ All checks passed"
          fi
