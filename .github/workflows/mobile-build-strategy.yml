name: Mobile Build Strategy

on:
  workflow_dispatch:
    inputs:
      build_method:
        description: "Build method"
        required: true
        type: choice
        options:
          - local-github-actions
          - eas-cloud
        default: "local-github-actions"
      platform:
        description: "Platform to build"
        required: true
        type: choice
        options:
          - android
          - ios
          - both
        default: "android"
      build_profile:
        description: "Build profile"
        required: true
        type: choice
        options:
          - development
          - preview
          - production
        default: "preview"

jobs:
  # Local build using GitHub Actions infrastructure
  local-build:
    name: Local Build (GitHub Actions)
    runs-on: ubuntu-latest
    if: github.event.inputs.build_method == 'local-github-actions'
    timeout-minutes: 60

    strategy:
      matrix:
        platform: ${{ github.event.inputs.platform == 'both' && fromJSON('["android", "ios"]') || fromJSON(format('["{0}"]', github.event.inputs.platform)) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: mobile/package-lock.json

      # Android-specific setup
      - name: Setup Java JDK (Android)
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Setup Android SDK
        if: matrix.platform == 'android'
        uses: android-actions/setup-android@v3
        with:
          packages: |
            platforms;android-34
            build-tools;34.0.0

      # iOS-specific setup (macOS runner required)
      - name: Switch to macOS runner for iOS
        if: matrix.platform == 'ios'
        run: |
          echo "âŒ iOS builds require macOS runners"
          echo "Consider using EAS build for iOS or switch to a macOS runner"
          exit 1

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.android/build-cache
            ~/.npm
            ~/.expo
            mobile/.expo
            mobile/node_modules/.cache
          key: ${{ runner.os }}-mobile-${{ matrix.platform }}-${{ hashFiles('mobile/package-lock.json') }}

      - name: Install dependencies
        working-directory: mobile
        run: npm ci

      - name: Setup Expo CLI
        run: npm install -g @expo/cli@latest

      - name: Create environment file
        working-directory: mobile
        env:
          PROFILE: ${{ github.event.inputs.build_profile }}
        run: |
          case "$PROFILE" in
            "development")
              echo "EXPO_PUBLIC_API_URL=http://10.0.2.2:5000" > .env
              ;;
            "preview")
              echo "EXPO_PUBLIC_API_URL=https://staging-api.yourdomain.com" > .env
              ;;
            "production")
              echo "EXPO_PUBLIC_API_URL=https://api.yourdomain.com" > .env
              ;;
          esac

      - name: Prebuild native code
        working-directory: mobile
        run: npx expo prebuild --platform ${{ matrix.platform }} --clear

      - name: Build Android APK
        if: matrix.platform == 'android'
        working-directory: mobile/android
        env:
          PROFILE: ${{ github.event.inputs.build_profile }}
        run: |
          chmod +x gradlew

          case "$PROFILE" in
            "development"|"preview")
              ./gradlew assembleDebug --no-daemon --stacktrace
              APK_PATH="app/build/outputs/apk/debug/app-debug.apk"
              ;;
            "production")
              ./gradlew assembleRelease --no-daemon --stacktrace
              APK_PATH="app/build/outputs/apk/release/app-release-unsigned.apk"
              ;;
          esac

          # Verify and set outputs
          if [ -f "$APK_PATH" ]; then
            APK_SIZE=$(stat -c%s "$APK_PATH" | numfmt --to=iec)
            echo "âœ… Android APK built successfully (Size: $APK_SIZE)"
            echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
            echo "APK_NAME=cityforge-${{ matrix.platform }}-$PROFILE-$(date +%Y%m%d-%H%M%S).apk" >> $GITHUB_ENV
          else
            echo "âŒ APK build failed"
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APK_NAME }}
          path: mobile/android/${{ env.APK_PATH }}
          retention-days: 30

  # Cloud build using EAS
  eas-build:
    name: EAS Cloud Build
    runs-on: ubuntu-latest
    if: github.event.inputs.build_method == 'eas-cloud'
    timeout-minutes: 45

    strategy:
      matrix:
        platform: ${{ github.event.inputs.platform == 'both' && fromJSON('["android", "ios"]') || fromJSON(format('["{0}"]', github.event.inputs.platform)) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: mobile/package-lock.json

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        working-directory: mobile
        run: npm ci

      - name: Build with EAS
        working-directory: mobile
        env:
          PLATFORM: ${{ matrix.platform }}
          PROFILE: ${{ github.event.inputs.build_profile }}
        run: |
          echo "ðŸš€ Starting EAS build for $PLATFORM with profile $PROFILE"

          eas build \
            --platform $PLATFORM \
            --profile $PROFILE \
            --non-interactive \
            --wait
            
          echo "âœ… EAS build completed"

      - name: Get build artifact URL
        working-directory: mobile
        env:
          PLATFORM: ${{ matrix.platform }}
        run: |
          # Get the latest build info
          BUILD_INFO=$(eas build:list --platform $PLATFORM --limit 1 --json)
          BUILD_URL=$(echo "$BUILD_INFO" | jq -r '.[0].artifacts.buildUrl // empty')

          if [ -n "$BUILD_URL" ]; then
            echo "ðŸ”— Build artifact URL: $BUILD_URL"
            echo "BUILD_URL=$BUILD_URL" >> $GITHUB_ENV
          fi

  # Summary job
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [local-build, eas-build]
    if: always()

    steps:
      - name: Create summary
        env:
          LOCAL_STATUS: ${{ needs.local-build.result }}
          EAS_STATUS: ${{ needs.eas-build.result }}
          BUILD_METHOD: ${{ github.event.inputs.build_method }}
          PLATFORM: ${{ github.event.inputs.platform }}
          PROFILE: ${{ github.event.inputs.build_profile }}
        run: |
          echo "## ðŸ“± Mobile Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Method**: $BUILD_METHOD" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: $PLATFORM" >> $GITHUB_STEP_SUMMARY
          echo "- **Profile**: $PROFILE" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$BUILD_METHOD" = "local-github-actions" ]; then
            echo "### Local Build Status: $LOCAL_STATUS" >> $GITHUB_STEP_SUMMARY
            if [ "$LOCAL_STATUS" = "success" ]; then
              echo "âœ… APK(s) available as workflow artifacts" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Build failed - check logs above" >> $GITHUB_STEP_SUMMARY
            fi
          elif [ "$BUILD_METHOD" = "eas-cloud" ]; then
            echo "### EAS Build Status: $EAS_STATUS" >> $GITHUB_STEP_SUMMARY
            if [ "$EAS_STATUS" = "success" ]; then
              echo "âœ… Check [Expo dashboard](https://expo.dev) for build artifacts" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Build failed - check logs above" >> $GITHUB_STEP_SUMMARY
            fi
          fi
