name: Android Local Build

on:
  push:
    branches: [main, develop]
    paths:
      - "mobile/**"
      - ".github/workflows/android-local-build.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "mobile/**"
      - ".github/workflows/android-local-build.yml"
  workflow_dispatch:
    inputs:
      build_type:
        description: "Build type"
        required: true
        type: choice
        options:
          - debug
          - release
        default: "debug"
      upload_artifact:
        description: "Upload APK as artifact"
        required: true
        type: boolean
        default: true

env:
  JAVA_VERSION: "17"
  NODE_VERSION: "20"

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: mobile/package-lock.json

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "temurin"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0
          ndk-version: 25.1.8937393

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.android/build-cache
          key: ${{ runner.os }}-gradle-${{ hashFiles('mobile/android/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Cache Expo and npm
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ~/.expo
            mobile/.expo
            mobile/node_modules/.cache
          key: ${{ runner.os }}-expo-local-${{ hashFiles('mobile/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-expo-local-

      - name: Install dependencies
        working-directory: mobile
        run: npm ci

      - name: Setup Expo CLI
        run: npm install -g @expo/cli@latest

      - name: Create environment file
        working-directory: mobile
        run: |
          echo "EXPO_PUBLIC_API_URL=http://10.0.2.2:5000" > .env

      - name: Generate native code (prebuild)
        working-directory: mobile
        run: |
          npx expo prebuild --platform android --clear

      - name: Grant execute permission for gradlew
        working-directory: mobile/android
        run: chmod +x gradlew

      - name: Determine build type
        id: build-type
        env:
          INPUT_BUILD_TYPE: ${{ github.event.inputs.build_type }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          if [ "$EVENT_NAME" == "workflow_dispatch" ]; then
            echo "type=$INPUT_BUILD_TYPE" >> $GITHUB_OUTPUT
          elif [ "$EVENT_NAME" == "pull_request" ]; then
            echo "type=debug" >> $GITHUB_OUTPUT
          else
            echo "type=release" >> $GITHUB_OUTPUT
          fi

      - name: Build debug APK
        if: steps.build-type.outputs.type == 'debug'
        working-directory: mobile/android
        run: |
          ./gradlew assembleDebug --no-daemon --stacktrace

          # Verify APK was created
          if [ ! -f app/build/outputs/apk/debug/app-debug.apk ]; then
            echo "‚ùå Debug APK build failed - file not found"
            exit 1
          fi

          # Get APK info
          APK_SIZE=$(stat -c%s app/build/outputs/apk/debug/app-debug.apk | numfmt --to=iec)
          echo "‚úÖ Debug APK built successfully (Size: $APK_SIZE)"
          echo "APK_PATH=app/build/outputs/apk/debug/app-debug.apk" >> $GITHUB_ENV
          echo "APK_NAME=cityforge-debug-$(date +%Y%m%d-%H%M%S).apk" >> $GITHUB_ENV

      - name: Build release APK
        if: steps.build-type.outputs.type == 'release'
        working-directory: mobile/android
        run: |
          # For release builds, you might want to add signing config
          # For now, building unsigned release APK
          ./gradlew assembleRelease --no-daemon --stacktrace

          # Verify APK was created
          if [ ! -f app/build/outputs/apk/release/app-release-unsigned.apk ]; then
            echo "‚ùå Release APK build failed - file not found"
            exit 1
          fi

          # Get APK info
          APK_SIZE=$(stat -c%s app/build/outputs/apk/release/app-release-unsigned.apk | numfmt --to=iec)
          echo "‚úÖ Release APK built successfully (Size: $APK_SIZE)"
          echo "APK_PATH=app/build/outputs/apk/release/app-release-unsigned.apk" >> $GITHUB_ENV
          echo "APK_NAME=cityforge-release-$(date +%Y%m%d-%H%M%S).apk" >> $GITHUB_ENV

      - name: Upload APK artifact
        if: github.event.inputs.upload_artifact != 'false'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APK_NAME }}
          path: mobile/android/${{ env.APK_PATH }}
          retention-days: 30

      - name: Add build summary
        env:
          BUILD_TYPE: ${{ steps.build-type.outputs.type }}
          APK_NAME: ${{ env.APK_NAME }}
          UPLOAD_ARTIFACT: ${{ github.event.inputs.upload_artifact }}
        run: |
          echo "## ü§ñ Android Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Type**: $BUILD_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "- **APK Name**: $APK_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$UPLOAD_ARTIFACT" != "false" ]; then
            echo "üì± **APK available as workflow artifact**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR with build info
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const buildType = '${{ steps.build-type.outputs.type }}';
            const apkName = '${{ env.APK_NAME }}';

            const body = `## ü§ñ Android Build Complete

            - **Build Type**: \`${buildType}\`
            - **APK**: \`${apkName}\`
            - **Status**: ‚úÖ Build successful

            üì± APK is available as a workflow artifact in the [Actions tab](${context.payload.repository.html_url}/actions/runs/${context.runId}).

            **To install**: Download the APK and install on your Android device.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # Optional: Test the built APK
  test-apk:
    name: Test APK
    runs-on: ubuntu-latest
    needs: build-android
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          pattern: cityforge-*
          merge-multiple: true

      - name: Verify APK structure
        run: |
          # Install aapt to analyze APK
          sudo apt-get update
          sudo apt-get install -y aapt

          # Find the APK file
          APK_FILE=$(find . -name "*.apk" | head -1)

          if [ -n "$APK_FILE" ]; then
            echo "üì± Analyzing APK: $APK_FILE"
            
            # Check APK package name
            PACKAGE=$(aapt dump badging "$APK_FILE" | grep "package:" | sed "s/.*name='\\([^']*\\)'.*/\\1/")
            echo "Package name: $PACKAGE"
            
            # Check APK size
            APK_SIZE=$(stat -c%s "$APK_FILE" | numfmt --to=iec)
            echo "APK size: $APK_SIZE"
            
            # Verify it's our app
            if [ "$PACKAGE" = "com.cityforge.mobile" ]; then
              echo "‚úÖ APK package name verification passed"
            else
              echo "‚ùå APK package name verification failed: expected 'com.cityforge.mobile', got '$PACKAGE'"
              exit 1
            fi
          else
            echo "‚ùå No APK file found"
            exit 1
          fi
