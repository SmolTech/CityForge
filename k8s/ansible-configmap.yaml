---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ansible-config
  namespace: cityforge
  labels:
    app: ansible-runner
    component: config
data:
  ansible.cfg: |
    [defaults]
    inventory = /ansible/inventory/inventory.ini
    host_key_checking = False
    retry_files_enabled = False
    gathering = smart
    fact_caching = memory
    stdout_callback = yaml
    bin_ansible_callbacks = True
    log_path = /ansible/logs/ansible.log
    remote_user = ubuntu
    private_key_file = /ansible/secrets/ssh-key
    vault_password_file = /ansible/secrets/vault-password

    [ssh_connection]
    ssh_args = -o ControlMaster=auto -o ControlPersist=60s -o UserKnownHostsFile=/dev/null -o IdentitiesOnly=yes
    pipelining = True
    control_path = /tmp/ssh-%%r@%%h:%%p

  inventory.ini: |
    [tunnel_servers]
    # Production servers
    prod-server-1 ansible_host=10.0.1.10 ansible_user=ubuntu
    prod-server-2 ansible_host=10.0.1.11 ansible_user=ubuntu

    # Staging servers
    staging-server-1 ansible_host=10.0.2.10 ansible_user=ubuntu

    # Development servers
    dev-server-1 ansible_host=192.168.1.100 ansible_user=ubuntu

    [production]
    prod-server-1
    prod-server-2

    [staging]
    staging-server-1

    [development]
    dev-server-1

    [tunnel_servers:vars]
    ansible_ssh_common_args='-o StrictHostKeyChecking=no'
    ansible_python_interpreter=/usr/bin/python3

  run-playbook.sh: |
    #!/bin/bash
    set -e

    # Default values
    PLAYBOOK="${PLAYBOOK:-cloudflare-tunnel.yml}"
    ENVIRONMENT="${ENVIRONMENT:-all}"
    CHECK_MODE="${CHECK_MODE:-false}"
    VAULT_PASSWORD_FILE="/ansible/secrets/vault-password"

    # Colors for output
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m'

    log_info() {
        echo -e "${GREEN}[INFO]${NC} $1"
    }

    log_warn() {
        echo -e "${YELLOW}[WARN]${NC} $1"
    }

    log_error() {
        echo -e "${RED}[ERROR]${NC} $1"
    }

    # Change to ansible directory
    cd /ansible

    log_info "Starting Ansible playbook execution"
    log_info "Playbook: $PLAYBOOK"
    log_info "Environment: $ENVIRONMENT"
    log_info "Check mode: $CHECK_MODE"

    # Prepare ansible command
    ANSIBLE_CMD="ansible-playbook /ansible/playbooks/$PLAYBOOK -l $ENVIRONMENT"

    # Add check mode if requested
    if [ "$CHECK_MODE" = "true" ]; then
        ANSIBLE_CMD="$ANSIBLE_CMD --check"
        log_info "Running in check mode (dry run)"
    fi

    # Add vault password file if it exists
    if [ -f "$VAULT_PASSWORD_FILE" ]; then
        ANSIBLE_CMD="$ANSIBLE_CMD --vault-password-file $VAULT_PASSWORD_FILE"
        log_info "Using vault password file"
    fi

    # Add extra variables if provided
    if [ -n "$EXTRA_VARS" ]; then
        ANSIBLE_CMD="$ANSIBLE_CMD --extra-vars '$EXTRA_VARS'"
        log_info "Extra variables: $EXTRA_VARS"
    fi

    # Test connectivity first
    log_info "Testing connectivity to $ENVIRONMENT..."
    if ansible $ENVIRONMENT -m ping; then
        log_info "Connectivity test successful"
    else
        log_error "Connectivity test failed"
        exit 1
    fi

    # Run the playbook
    log_info "Executing: $ANSIBLE_CMD"
    if eval $ANSIBLE_CMD; then
        log_info "Playbook execution completed successfully"
    else
        log_error "Playbook execution failed"
        exit 1
    fi

    # Show final status
    log_info "Checking service status..."
    ansible $ENVIRONMENT -m shell -a "systemctl is-active cloudflared || true"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ansible-group-vars-all
  namespace: cityforge
  labels:
    app: ansible-runner
    component: group-vars
data:
  all.yml: |
    ---
    # Cloudflare tunnel configuration
    tunnel_name: "cityforge-tunnel"
    tunnel_uuid: "{{ vault_tunnel_uuid | default('your-tunnel-uuid-here') }}"

    # Tunnel credentials will be loaded from vault
    tunnel_credentials: "{{ vault_tunnel_credentials }}"

    # Tunnel ingress rules
    tunnel_ingress:
      - hostname: "app.yourdomain.com"
        service: "http://localhost:3000"
      - hostname: "api.yourdomain.com" 
        service: "http://localhost:5000"
      - hostname: "admin.yourdomain.com"
        service: "http://localhost:3000"
        path: "/admin/*"
      - service: "http_status:404"

    # Cloudflared configuration
    cloudflared_log_level: "info"
    cloudflared_log_file: "/var/log/cloudflared/cloudflared.log"
    cloudflared_metrics_port: 8080
    cloudflared_no_autoupdate: true

    # System configuration
    enable_firewall: true
    cloudflared_version: "2024.10.0"

    # Additional tunnel options
    tunnel_options:
      grace_period: "30s"
      hello_world: false
      protocol: "http2"
      retries: 5
      heartbeat_interval: "10s"
      max_heartbeats: 10

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ansible-group-vars-production
  namespace: cityforge
  labels:
    app: ansible-runner
    component: group-vars
data:
  production.yml: |
    ---
    # Production-specific configuration
    tunnel_name: "cityforge-prod-tunnel"
    tunnel_uuid: "{{ vault_prod_tunnel_uuid }}"

    # Production ingress rules
    tunnel_ingress:
      - hostname: "cityforge.com"
        service: "http://localhost:3000"
      - hostname: "www.cityforge.com"
        service: "http://localhost:3000"
      - hostname: "api.cityforge.com"
        service: "http://localhost:5000"
      - hostname: "admin.cityforge.com"
        service: "http://localhost:3000"
        path: "/admin/*"
      - service: "http_status:404"

    # Production logging
    cloudflared_log_level: "warn"

    # Production tunnel options
    tunnel_options:
      grace_period: "60s"
      hello_world: false
      protocol: "http2"
      retries: 10
      heartbeat_interval: "5s"
      max_heartbeats: 20
