---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: ansible-tunnel-deploy-scheduled
  namespace: cityforge
  labels:
    app: ansible-runner
    component: cronjob
    job-type: tunnel-deploy
spec:
  schedule: "0 2 * * 1" # Run every Monday at 2 AM UTC
  timezone: "UTC"
  concurrencyPolicy: Forbid # Don't run concurrent jobs
  failedJobsHistoryLimit: 3
  successfulJobsHistoryLimit: 3
  startingDeadlineSeconds: 300 # Start within 5 minutes of scheduled time

  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 7200 # Clean up after 2 hours
      backoffLimit: 1
      template:
        metadata:
          labels:
            app: ansible-runner
            component: cronjob
        spec:
          serviceAccountName: ansible-runner
          restartPolicy: Never
          containers:
            - name: ansible
              image: ghcr.io/smoltech/cityforge/ansible-runner:latest
              env:
                - name: PLAYBOOK
                  value: "cloudflare-tunnel.yml"
                - name: ENVIRONMENT
                  value: "production"
                - name: CHECK_MODE
                  value: "false"
                - name: EXTRA_VARS
                  value: "scheduled_run=true"
              command: ["/bin/bash"]
              args: ["/ansible/scripts/run-playbook.sh"]

              volumeMounts:
                - name: ansible-config
                  mountPath: /ansible/ansible.cfg
                  subPath: ansible.cfg
                - name: ansible-config
                  mountPath: /ansible/inventory/inventory.ini
                  subPath: inventory.ini
                - name: ansible-config
                  mountPath: /ansible/scripts/run-playbook.sh
                  subPath: run-playbook.sh
                - name: ansible-group-vars-all
                  mountPath: /ansible/group_vars/all.yml
                  subPath: all.yml
                - name: ansible-group-vars-production
                  mountPath: /ansible/group_vars/production.yml
                  subPath: production.yml
                - name: ansible-ssh-key
                  mountPath: /ansible/secrets/ssh-key
                  subPath: ssh-key
                  readOnly: true
                - name: ansible-vault-password
                  mountPath: /ansible/secrets/vault-password
                  subPath: vault-password
                  readOnly: true
                - name: ansible-vault
                  mountPath: /ansible/vault.yml
                  subPath: vault.yml
                  readOnly: true
                - name: ansible-logs
                  mountPath: /ansible/logs

              resources:
                requests:
                  memory: "256Mi"
                  cpu: "200m"
                limits:
                  memory: "512Mi"
                  cpu: "500m"

          volumes:
            - name: ansible-config
              configMap:
                name: ansible-config
                defaultMode: 0755
            - name: ansible-group-vars-all
              configMap:
                name: ansible-group-vars-all
            - name: ansible-group-vars-production
              configMap:
                name: ansible-group-vars-production
            - name: ansible-ssh-key
              secret:
                secretName: ansible-ssh-key
                defaultMode: 0600
            - name: ansible-vault-password
              secret:
                secretName: ansible-vault-password
                defaultMode: 0600
            - name: ansible-vault
              secret:
                secretName: ansible-vault
                defaultMode: 0600
            - name: ansible-logs
              emptyDir: {}

---
# CronJob for tunnel health checks
apiVersion: batch/v1
kind: CronJob
metadata:
  name: ansible-tunnel-health-check
  namespace: cityforge
  labels:
    app: ansible-runner
    component: cronjob
    job-type: health-check
spec:
  schedule: "*/30 * * * *" # Run every 30 minutes
  timezone: "UTC"
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 2
  successfulJobsHistoryLimit: 1

  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 3600
      template:
        metadata:
          labels:
            app: ansible-runner
            component: health-check
        spec:
          serviceAccountName: ansible-runner
          restartPolicy: Never
          containers:
            - name: ansible
              image: ghcr.io/smoltech/cityforge/ansible-runner:latest
              command: ["/bin/bash", "-c"]
              args:
                - |
                  cd /ansible
                  echo "=== Tunnel Health Check $(date) ==="

                  # Check if cloudflared service is running
                  echo "Checking service status..."
                  ansible all -m shell -a "systemctl is-active cloudflared" --one-line || {
                    echo "ERROR: Some tunnels are not active!"
                    # Optionally restart failed services
                    echo "Attempting to restart failed services..."
                    ansible all -m shell -a "systemctl restart cloudflared" --become || true
                    sleep 10
                    ansible all -m shell -a "systemctl is-active cloudflared" --one-line || true
                  }

                  # Check tunnel connectivity
                  echo "Checking tunnel connectivity..."
                  ansible all -m shell -a "timeout 10 cloudflared tunnel info \${tunnel_name} 2>/dev/null || echo 'Tunnel check failed'" --one-line || true

                  echo "=== Health Check Complete ==="

              volumeMounts:
                - name: ansible-config
                  mountPath: /ansible/ansible.cfg
                  subPath: ansible.cfg
                - name: ansible-config
                  mountPath: /ansible/inventory/inventory.ini
                  subPath: inventory.ini
                - name: ansible-group-vars-all
                  mountPath: /ansible/group_vars/all.yml
                  subPath: all.yml
                - name: ansible-ssh-key
                  mountPath: /ansible/secrets/ssh-key
                  subPath: ssh-key
                  readOnly: true

              resources:
                requests:
                  memory: "128Mi"
                  cpu: "100m"
                limits:
                  memory: "256Mi"
                  cpu: "200m"

          volumes:
            - name: ansible-config
              configMap:
                name: ansible-config
            - name: ansible-group-vars-all
              configMap:
                name: ansible-group-vars-all
            - name: ansible-ssh-key
              secret:
                secretName: ansible-ssh-key
                defaultMode: 0600
