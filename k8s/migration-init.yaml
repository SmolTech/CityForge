# Standalone migration init container configuration
# You can add this initContainers section to your existing deployment.yaml

# Init container configuration for database migrations
initContainers:
  - name: prisma-migration
    image: ghcr.io/smoltech/cityforge-frontend:latest
    imagePullPolicy: Always
    # Use the same security context as main container
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false
      runAsNonRoot: true
      runAsUser: 1001
      runAsGroup: 1001
      capabilities:
        drop:
          - ALL
    # Migration commands
    command: ["/bin/sh"]
    args:
      - -c
      - |
        set -e
        echo "=== Starting database migration ==="

        # Construct DATABASE_URL from environment variables
        export DATABASE_URL="postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}"
        echo "Connecting to: postgresql://${POSTGRES_USER}:***@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}"

        # Generate Prisma client
        echo "Generating Prisma client..."
        npx prisma generate

        # Apply migrations (production-safe)
        echo "Applying database migrations..."
        npx prisma migrate deploy

        # Alternative: Use db push for development
        # npx prisma db push

        echo "=== Database migration completed successfully ==="

    # Same environment variables as main container
    env:
      - name: NODE_ENV
        value: "production"

      # Database connection
      - name: POSTGRES_USER
        valueFrom:
          secretKeyRef:
            key: username
            name: cityforge.cityforge-db.credentials.postgresql.acid.zalan.do
      - name: POSTGRES_PASSWORD
        valueFrom:
          secretKeyRef:
            key: password
            name: cityforge.cityforge-db.credentials.postgresql.acid.zalan.do
      - name: POSTGRES_HOST
        valueFrom:
          configMapKeyRef:
            name: cityforge-config
            key: POSTGRES_HOST
      - name: POSTGRES_PORT
        valueFrom:
          configMapKeyRef:
            name: cityforge-config
            key: POSTGRES_PORT
      - name: POSTGRES_DB
        valueFrom:
          configMapKeyRef:
            name: cityforge-config
            key: POSTGRES_DB

    # Resource limits for migration container
    resources:
      requests:
        memory: "128Mi"
        cpu: "100m"
      limits:
        memory: "256Mi"
        cpu: "500m"
